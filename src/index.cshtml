@using System.Configuration;
@using System.Web.Caching;
@{
	// Make sure all URLs end with a slash
	if (!Request.QueryString["path"].EndsWith("/"))
	{
		Response.RedirectPermanent(Request.QueryString["path"] + "/", true);
	}

	MarkdownPage page = PageSystem.GetCurrentPage(Request);

	Page.Title = PageSystem.GetTitle(page);
	Page.Description = page.Description;
	Page.Keywords = page.Keywords;
	Page.Theme = ConfigurationManager.AppSettings["theme"];

	Layout = "~/themes/" + Page.Theme + "/_layout.cshtml";

	WebPageHttpHandler.DisableWebPagesResponseHeader = true;
	PageSystem.SetConditionalGetHeaders(page.DateModified.ToLocalTime(), Context);

	if (!Request.IsLocal)
	{
		Response.Cache.SetValidUntilExpires(true);
		Response.Cache.SetCacheability(HttpCacheability.ServerAndPrivate);
		Response.Cache.VaryByParams["path"] = true;
		Response.AddCacheDependency(new CacheDependency(Server.MapPath(ConfigurationManager.AppSettings["pageFolder"] + page.FileName)));
		Response.AddCacheDependency(new CacheDependency(Server.MapPath("~/")));
		Response.AddCacheDependency(new CacheDependency(Server.MapPath("~/themes/" + Page.Theme)));
		Response.Cache.SetLastModifiedFromFileDependencies();
	}
}

@RenderPage("themes/" + Page.Theme + "/page.cshtml", page)